/* soma.js - v2.0.0 - 2013-05-02 - http://somajs.github.io/somajs - http://www.soundstep.com */(function(infuse,undefined){"use strict";infuse.version="0.6.3";var FN_ARGS=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,FN_ARG_SPLIT=/,/,FN_ARG=/^\s*(_?)(\S+?)\1\s*$/,STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm;Array.prototype.contains||(Array.prototype.contains=function(value){for(var i=this.length;i--;)if(this[i]===value)return!0;return!1}),infuse.InjectorError={MAPPING_BAD_PROP:"[Error infuse.Injector.mapClass/mapValue] the first parameter is invalid, a string is expected",MAPPING_BAD_VALUE:"[Error infuse.Injector.mapClass/mapValue] the second parameter is invalid, it can't null or undefined, with property: ",MAPPING_BAD_CLASS:"[Error infuse.Injector.mapClass/mapValue] the second parameter is invalid, a function is expected, with property: ",MAPPING_BAD_SINGLETON:"[Error infuse.Injector.mapClass] the third parameter is invalid, a boolean is expected, with property: ",MAPPING_ALREADY_EXISTS:"[Error infuse.Injector.mapClass/mapValue] this mapping already exists, with property: ",CREATE_INSTANCE_INVALID_PARAM:"[Error infuse.Injector.createInstance] invalid parameter, a function is expected",NO_MAPPING_FOUND:"[Error infuse.Injector.getInstance] no mapping found",INJECT_INSTANCE_IN_ITSELF_PROPERTY:"[Error infuse.Injector.getInjectedValue] A matching property has been found in the target, you can't inject an instance in itself",INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR:"[Error infuse.Injector.getInjectedValue] A matching constructor parameter has been found in the target, you can't inject an instance in itself"};var MappingVO=function(prop,value,cl,singleton){this.prop=prop,this.value=value,this.cl=cl,this.singleton=singleton||!1},validateProp=function(prop){if("string"!=typeof prop)throw Error(infuse.InjectorError.MAPPING_BAD_PROP)},validateValue=function(prop,val){if(val===undefined||null===val)throw Error(infuse.InjectorError.MAPPING_BAD_VALUE+prop)},validateClass=function(prop,val){if("function"!=typeof val)throw Error(infuse.InjectorError.MAPPING_BAD_CLASS+prop)},validateBooleanSingleton=function(prop,singleton){if("boolean"!=typeof singleton)throw Error(infuse.InjectorError.MAPPING_BAD_SINGLETON+prop)},validateConstructorInjectionLoop=function(name,cl){var params=infuse.getConstructorParams(cl);if(params.contains(name))throw Error(infuse.InjectorError.INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR)},validatePropertyInjectionLoop=function(name,target){if(target.hasOwnProperty(name))throw Error(infuse.InjectorError.INJECT_INSTANCE_IN_ITSELF_PROPERTY)};infuse.Injector=function(){this.mappings={},this.parent=null},infuse.getConstructorParams=function(cl){for(var args=[],clStr=(""+cl).replace(STRIP_COMMENTS,""),argsFlat=clStr.match(FN_ARGS),spl=argsFlat[1].split(FN_ARG_SPLIT),i=0;spl.length>i;i++){var arg=spl[i];arg.replace(FN_ARG,function(all,underscore,name){args.push(name)})}return args},infuse.Injector.prototype={createChild:function(){var injector=new infuse.Injector;return injector.parent=this,injector},getMappingVo:function(prop){return this.mappings?this.mappings[prop]?this.mappings[prop]:this.parent?this.parent.getMappingVo(prop):null:null},mapValue:function(prop,val){if(this.mappings[prop])throw Error(infuse.InjectorError.MAPPING_ALREADY_EXISTS+prop);return validateProp(prop),validateValue(prop,val),this.mappings[prop]=new MappingVO(prop,val),this},mapClass:function(prop,cl,singleton){if(this.mappings[prop])throw Error(infuse.InjectorError.MAPPING_ALREADY_EXISTS+prop);return validateProp(prop),validateClass(prop,cl),singleton&&validateBooleanSingleton(prop,singleton),this.mappings[prop]=new MappingVO(prop,null,cl,singleton),this},removeMapping:function(prop){return this.mappings[prop]=null,delete this.mappings[prop],this},hasMapping:function(prop){return!!this.mappings[prop]},hasInheritedMapping:function(prop){return!!this.getMappingVo(prop)},getMapping:function(value){for(var name in this.mappings){var vo=this.mappings[name];if(vo.value===value||vo.cl===value)return vo.prop}},getValue:function(prop){var vo=this.mappings[prop];if(!vo){if(this.parent)return this.parent.getValue.apply(this.parent,arguments);throw Error(infuse.InjectorError.NO_MAPPING_FOUND)}return vo.cl?(arguments[0]=vo.cl,this.getValueFromClass.apply(this,arguments)):vo.value},getClass:function(prop){var vo=this.mappings[prop];return vo?vo.cl?vo.cl:undefined:this.parent?this.parent.getClass(prop):undefined},instantiate:function(TargetClass){if("function"!=typeof TargetClass)throw Error(infuse.InjectorError.CREATE_INSTANCE_INVALID_PARAM);for(var TargetClass=arguments[0],args=[null],params=infuse.getConstructorParams(TargetClass,this.mappings),i=0;params.length>i;i++)if(arguments[i+1]!==undefined&&null!==arguments[i+1])args.push(arguments[i+1]);else{var name=params[i],vo=this.getMappingVo(name);if(vo){var val=this.getInjectedValue(vo,name);args.push(val)}else args.push(undefined)}return new(Function.prototype.bind.apply(TargetClass,args))},inject:function(target,isParent){this.parent&&this.parent.inject(target,!0);for(var name in this.mappings){var vo=this.getMappingVo(name);if(target.hasOwnProperty(vo.prop)){var val=this.getInjectedValue(vo,name);target[name]=val}}return"function"!=typeof target.postConstruct||isParent||target.postConstruct(),this},getInjectedValue:function(vo,name){var injectee,val=vo.value;return vo.cl&&(infuse.getConstructorParams(vo.cl),vo.singleton?(vo.value||(validateConstructorInjectionLoop(name,vo.cl),vo.value=this.instantiate(vo.cl),injectee=vo.value),val=vo.value):(validateConstructorInjectionLoop(name,vo.cl),val=this.instantiate(vo.cl),injectee=val)),injectee&&(validatePropertyInjectionLoop(name,injectee),this.inject(injectee)),val},createInstance:function(){var instance=this.instantiate.apply(this,arguments);return this.inject(instance),instance},getValueFromClass:function(cl){for(var name in this.mappings){var vo=this.mappings[name];if(vo.cl==cl)return vo.singleton?(vo.value||(vo.value=this.createInstance.apply(this,arguments)),vo.value):this.createInstance.apply(this,arguments)}if(this.parent)return this.parent.getValueFromClass.apply(this.parent,arguments);throw Error(infuse.InjectorError.NO_MAPPING_FOUND)},dispose:function(){this.mappings={}}},Function.prototype.bind||(Function.prototype.bind=function(that){var target=this;if("function"!=typeof target)throw Error("Error, you must bind a function.");var args=Array.prototype.slice.call(arguments,1),bound=function(){if(this instanceof bound){var F=function(){};F.prototype=target.prototype;var self=new F,result=target.apply(self,args.concat(Array.prototype.slice.call(arguments)));return Object(result)===result?result:self}return target.apply(that,args.concat(Array.prototype.slice.call(arguments)))};return bound}),"function"==typeof define&&define.amd&&define("infuse",infuse),"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=infuse),exports=infuse)})(this.infuse=this.infuse||{}),function(soma,undefined){"use strict";soma.events={},soma.events.version="0.5.2",Function.prototype.bind||(Function.prototype.bind=function(that){var target=this;if("function"!=typeof target)throw Error("Error, you must bind a function.");var args=Array.prototype.slice.call(arguments,1),bound=function(){if(this instanceof bound){var F=function(){};F.prototype=target.prototype;var self=new F,result=target.apply(self,args.concat(Array.prototype.slice.call(arguments)));return Object(result)===result?result:self}return target.apply(that,args.concat(Array.prototype.slice.call(arguments)))};return bound}),soma.Event=function(type,params,bubbles,cancelable){var e=soma.Event.createGenericEvent(type,bubbles,cancelable);return null!==params&&params!==undefined&&(e.params=params),e.isCloned=!1,e.clone=this.clone.bind(e),e.isIE9=this.isIE9,e.isDefaultPrevented=this.isDefaultPrevented,(this.isIE9()||!e.preventDefault||e.getDefaultPrevented===undefined&&e.defaultPrevented===undefined)&&(e.preventDefault=this.preventDefault.bind(e)),this.isIE9()&&(e.IE9PreventDefault=!1),e},soma.Event.prototype.clone=function(){var e=soma.Event.createGenericEvent(this.type,this.bubbles,this.cancelable);return e.params=this.params,e.isCloned=!0,e.clone=this.clone,e.isDefaultPrevented=this.isDefaultPrevented,e.isIE9=this.isIE9,this.isIE9()&&(e.IE9PreventDefault=this.IE9PreventDefault),e},soma.Event.prototype.preventDefault=function(){return this.cancelable?(this.defaultPrevented=!0,this.isIE9()&&(this.IE9PreventDefault=!0),this):!1},soma.Event.prototype.isDefaultPrevented=function(){return this.cancelable?this.isIE9()?this.IE9PreventDefault:this.defaultPrevented!==undefined?this.defaultPrevented:this.getDefaultPrevented!==undefined?this.getDefaultPrevented():!1:!1},soma.Event.createGenericEvent=function(type,bubbles,cancelable){var event;return bubbles=bubbles!==undefined?bubbles:!0,"object"==typeof document&&document.createEvent?(event=document.createEvent("Event"),event.initEvent(type,!!bubbles,!!cancelable)):"object"==typeof document&&document.createEventObject?(event=document.createEventObject(),event.type=type,event.bubbles=!!bubbles,event.cancelable=!!cancelable):event=new EventObject(type,!!bubbles,!!cancelable),event},soma.Event.prototype.isIE9=function(){return"object"!=typeof document?!1:document.body.style.scrollbar3dLightColor!==undefined&&document.body.style.opacity!==undefined},soma.Event.prototype.toString=function(){return"[soma.Event]"};var EventObject=function(type,bubbles,cancelable){this.type=type,this.bubbles=!!bubbles,this.cancelable=!!cancelable,this.defaultPrevented=!1,this.currentTarget=null,this.target=null};soma.EventDispatcher=function(){this.listeners=[]},soma.EventDispatcher.prototype.addEventListener=function(type,listener,priority){if(this.listeners&&type&&listener){isNaN(priority)&&(priority=0);for(var i=0;this.listeners.length>i;i++){var eventObj=this.listeners[i];if(eventObj.type===type&&eventObj.listener===listener)return}this.listeners.push({type:type,listener:listener,priority:priority,scope:this})}},soma.EventDispatcher.prototype.removeEventListener=function(type,listener){if(this.listeners&&type&&listener)for(var i=this.listeners.length;i-->0;){var eventObj=this.listeners[i];eventObj.type===type&&eventObj.listener===listener&&this.listeners.splice(i,1)}},soma.EventDispatcher.prototype.hasEventListener=function(type){if(!this.listeners||!type)return!1;for(var i=0,l=this.listeners.length;l>i;++i){var eventObj=this.listeners[i];if(eventObj.type===type)return!0}return!1},soma.EventDispatcher.prototype.dispatchEvent=function(event){if(!this.listeners||!event)throw Error("Error in EventDispatcher (dispatchEvent), one of the parameters is null or undefined.");var i,events=[];for(i=0;this.listeners.length>i;i++){var eventObj=this.listeners[i];eventObj.type===event.type&&events.push(eventObj)}for(events.sort(function(a,b){return b.priority-a.priority}),i=0;events.length>i;i++)events[i].listener.apply(event.srcElement?event.srcElement:event.currentTarget,[event]);return!event.isDefaultPrevented()},soma.EventDispatcher.prototype.dispatch=function(type,params,bubbles,cancelable){if(!this.listeners||!type||""===type)throw Error("Error in EventDispatcher (dispatch), one of the parameters is null or undefined.");var event=new soma.Event(type,params,bubbles,cancelable);return this.dispatchEvent(event),event},soma.EventDispatcher.prototype.dispose=function(){this.listeners=null},soma.EventDispatcher.prototype.toString=function(){return"[soma.EventDispatcher]"},"function"==typeof define&&define.amd&&define("soma-events",soma),"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=soma),exports=soma)}(this.soma=this.soma||{}),function(soma,infuse,undefined){"use strict";soma.version="2.0.0",soma.applyProperties=function(target,extension,bindToExtension,list){if("[object Array]"===Object.prototype.toString.apply(list))for(var i=0,l=list.length;l>i;i++)(target[list[i]]===undefined||null===target[list[i]])&&(target[list[i]]=bindToExtension&&"function"==typeof extension[list[i]]?extension[list[i]].bind(extension):extension[list[i]]);else for(var prop in extension)target[prop]=bindToExtension&&"function"==typeof extension[prop]?extension[prop].bind(extension):extension[prop]},soma.augment=function(target,extension,list){if(extension.prototype&&target.prototype)if("[object Array]"===Object.prototype.toString.apply(list))for(var i=0,l=list.length;l>i;i++)target.prototype[list[i]]||(target.prototype[list[i]]=extension.prototype[list[i]]);else for(var prop in extension.prototype)target.prototype[prop]||(target.prototype[prop]=extension.prototype[prop])},soma.inherit=function(parent,obj){var Subclass;Subclass=obj&&obj.hasOwnProperty("constructor")?obj.constructor:function(){return parent.apply(this,arguments)};var Chain=function(){};return Chain.prototype=parent.prototype,Subclass.prototype=new Chain,obj&&soma.applyProperties(Subclass.prototype,obj),Subclass.prototype.constructor=Subclass,Subclass.parent=parent.prototype,Subclass.extend=function(obj){return soma.inherit(Subclass,obj)},Subclass},soma.extend=function(obj){return soma.inherit(function(){},obj)};var plugins=[];soma.plugins=soma.plugins||{},soma.plugins.add=function(plugin){plugins.push(plugin)},soma.plugins.remove=function(plugin){for(var i=plugins.length-1,l=0;i>=l;i--)plugin===plugins[i]&&plugins.splice(i,1)},soma.Application=soma.extend({constructor:function(){function setup(){this.injector=new infuse.Injector(this.dispatcher),this.dispatcher=new soma.EventDispatcher,this.injector.mapValue("injector",this.injector),this.injector.mapValue("instance",this),this.injector.mapValue("dispatcher",this.dispatcher),this.injector.mapClass("mediators",Mediators,!0),this.mediators=this.injector.getValue("mediators"),this.injector.mapClass("commands",Commands,!0),this.commands=this.injector.getValue("commands");for(var i=0,l=plugins.length;l>i;i++)this.createPlugin(plugins[i])}setup.bind(this)(),this.init(),this.start()},createPlugin:function(){if(0==arguments.length||!arguments[0])throw Error("Error creating a plugin, plugin class is missing.");for(var params=infuse.getConstructorParams(arguments[0]),args=[arguments[0]],i=0;params.length>i;i++)(this.injector.hasMapping(params[i])||this.injector.hasInheritedMapping(params[i]))&&args.push(this.injector.getValue(params[i]));for(var j=1;arguments.length>j;j++)args.push(arguments[j]);return this.injector.createInstance.apply(this.injector,args)},init:function(){},start:function(){},dispose:function(){this.injector&&(this.injector.removeMapping("injector"),this.injector.removeMapping("dispatcher"),this.injector.removeMapping("mediators"),this.injector.removeMapping("commands"),this.injector.removeMapping("instance")),this.injector&&this.injector.dispose(),this.dispatcher&&this.dispatcher.dispose(),this.mediators&&this.mediators.dispose(),this.commands&&this.commands.dispose(),this.injector=undefined,this.dispatcher=undefined,this.mediators=undefined,this.commands=undefined,this.instance=undefined}});var Mediators=soma.extend({constructor:function(){this.injector=null,this.dispatcher=null},create:function(cl,target){if(!cl||"function"!=typeof cl)throw Error("Error creating a mediator, the first parameter must be a function.");if(target===undefined||null===target)throw Error("Error creating a mediator, the second parameter cannot be undefined or null.");var targets=[],meds=[];target.length>0?targets=target:targets.push(target);for(var i=0,l=targets.length;l>i;i++){var injector=this.injector.createChild();injector.mapValue("target",targets[i]);var mediator=injector.createInstance(cl);if(1===targets.length)return mediator;meds.push(mediator)}return meds},dispose:function(){this.injector=undefined,this.dispatcher=undefined}}),Commands=soma.extend({constructor:function(){this.boundHandler=this.handler.bind(this),this.dispatcher=null,this.injector=null,this.list={}},has:function(commandName){return null!==this.list[commandName]&&this.list[commandName]!==undefined},get:function(commandName){return this.has(commandName)?this.list[commandName]:undefined},getAll:function(){var copy={};for(var cmd in this.list)copy[cmd]=this.list[cmd];return copy},add:function(commandName,command){if("string"!=typeof commandName)throw Error("Error adding a command, the first parameter must be a string.");if("function"!=typeof command)throw Error('Error adding a command with the name "'+command+'", the second parameter must be a function, and must contain an "execute" public method.');if(this.has(commandName))throw Error('Error adding a command with the name: "'+commandName+'", already registered.');this.list[commandName]=command,this.addInterceptor(commandName)},remove:function(commandName){this.has(commandName)&&(this.list[commandName]=undefined,delete this.list[commandName],this.removeInterceptor(commandName))},addInterceptor:function(commandName){this.dispatcher.addEventListener(commandName,this.boundHandler,-Number.MAX_VALUE)},removeInterceptor:function(commandName){this.dispatcher.removeEventListener(commandName,this.boundHandler)},handler:function(event){event.isDefaultPrevented&&!event.isDefaultPrevented()&&this.executeCommand(event)},executeCommand:function(event){var commandName=event.type;if(this.has(commandName)){var command=this.injector.createInstance(this.list[commandName]);if(!command.hasOwnProperty("execute")&&"function"===command.execute)throw Error("Error in "+this+' Command "'+command+'" must contain an execute public method.');command.execute(event)}},dispose:function(){for(var cmd in this.list)this.remove(cmd);this.boundHandler=undefined,this.dispatcher=undefined,this.injector=undefined,this.list=undefined}});soma.EventDispatcher.extend=function(obj){return soma.inherit(soma.EventDispatcher,obj)},soma.Event.extend=function(obj){return soma.inherit(soma.Event,obj)},infuse.Injector.extend=function(obj){return soma.inherit(infuse.Injector,obj)},"function"==typeof define&&define.amd&&define("soma",soma),"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=soma),exports=soma)}(this.soma=this.soma||{},this.infuse);